from flowplot import FlowPlot, RandomData
import struct
import serial

class SerialWrapper:
	TAU = 10

	def __init__(self):
		self.title="Scale Plot"
		self.low=0.0
		self.high=1024.0

		self.ser = serial.Serial()
		self.ser.port = "/dev/ttyUSB0"
		self.ser.baudrate = 19200
		self.ser.bytesize =serial.EIGHTBITS
		self.ser.parity = serial.PARITY_NONE
		self.ser.stopbits = serial.STOPBITS_ONE
		self.ser.timeout = 1
		self.ser.xonxoff = False
	
		self.ser.open()

		#self.history = list()
		self.previous = 0
		self.ser.flushInput()

	def get(self):
		try:	
			self.ser.write(":gimmesomesuga\n")

			while self.ser.read() != ':':
				pass;

			raw = self.ser.readline().rstrip('\n')
			data = int(raw, 16)
			#print ":".join("{:02x}".format(ord(c)) for c in raw)
			#data = struct.unpack('<L', raw + "\0")[0]
			#normalized = (data - 0) / 1024.0
			result = (data + self.TAU * self.previous) / (1 + self.TAU)
			self.previous = result
			return result
		except struct.error:
			return 0;

sw = SerialWrapper()

datasource = sw
fp = FlowPlot(datasource, 30, 100, 1280, 720)
fp.run();

#while(1):
#	sw = SerialWrapper()
#	print sw.get()

